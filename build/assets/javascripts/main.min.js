function createPoint(e,t){return new Phaser.Point(e*32,t*32)}Key=function(e,t,n,r){Phaser.Sprite.call(this,e,t,n,"key");this.doorSet=r;e.add.existing(this)};Key.prototype=Object.create(Phaser.Sprite.prototype);Key.prototype.constructor=Key;var game=new Phaser.Game(320,480,Phaser.CANVAS,"game-screen");var NORTH=0;var SOUTH=1;var EAST=2;var WEST=3;var score;var player;var princess;var cursors;var map;var hearts;var enemies;var emitter;var up=false;var right=false;var down=false;var left=false;var face=SOUTH;var doors;var keysArray=[];var chest;var invitText;var resultText;var timer;var timerText;var mainStyle;var promtText;var trees;var respawnPosition=createPoint(5,2);var heartPositions=[createPoint(1.5,19.5),createPoint(7.5,19.5),createPoint(2,36)];var enemyPositions=[createPoint(15,20),createPoint(17,20),createPoint(4,13),createPoint(15,23),createPoint(4,36)];var keyPositions=[createPoint(2,15),createPoint(23,2),createPoint(1.5,29)];var doorPositions=[[createPoint(7,17),createPoint(8,17)],[createPoint(15,20),createPoint(16,20),createPoint(17,20),createPoint(3,19),createPoint(3,20)],[createPoint(26,19),createPoint(27,19),createPoint(28,19)]];var princessPosition=createPoint(40.5,8);var chestPosition=createPoint(55,25);var treePositions=[createPoint(26,22),createPoint(26,23)];var mainState={preload:function(){game.load.tilemap("map","assets/tilemaps/maps/main.min.json",null,Phaser.Tilemap.TILED_JSON);game.load.image("tiles","assets/tilemaps/tiles/tiles.png");game.load.image("heart","assets/sprites/heart.png");game.load.image("enemy","assets/sprites/enemy.png");game.load.image("flower","assets/sprites/flower.png");game.load.image("diamond","assets/sprites/diamond.png");game.load.image("star","assets/sprites/star_particle.png");game.load.image("key","assets/sprites/key.png");game.load.image("door","assets/sprites/door.png");game.load.image("princess","assets/sprites/princess.png");game.load.image("chest","assets/sprites/chest.png");game.load.spritesheet("player","assets/sprites/player.png",28,32);game.load.spritesheet("buttonvertical","assets/buttons/button-vertical.png",64,64);game.load.spritesheet("buttonhorizontal","assets/buttons/button-horizontal.png",96,64);game.load.spritesheet("tree","assets/tilemaps/tiles/tiles.png",32,32,1);game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL;game.scale.fullScreenScaleMode=Phaser.ScaleManager.EXACT_FIT},create:function(){if(!game.device.desktop){game.input.onDown.add(this.fullScreen,this)}score=0;game.physics.startSystem(Phaser.Physics.ARCADE);map=game.add.tilemap("map");map.addTilesetImage("tiles");layer=map.createLayer("Tile Layer 1");layer.resizeWorld();map.setCollisionBetween(1,8);player=game.add.sprite(respawnPosition.x,respawnPosition.y,"player");game.physics.enable(player);player.body.fixedRotation=true;player.body.collideWorldBounds=true;player.animations.add("walk_down",[1,2],5,true);player.animations.add("walk_up",[4,5],5,true);player.animations.add("walk_left",[7,8],5,true);player.animations.add("walk_right",[10,11],5,true);hearts=game.add.group();hearts.enableBody=true;for(var e=0;e<heartPositions.length;e++){hearts.create(heartPositions[e].x,heartPositions[e].y,"heart")}enemies=game.add.group();enemies.enableBody=true;for(var e=0;e<enemyPositions.length;e++){var t=enemies.create(enemyPositions[e].x,enemyPositions[e].y,"enemy");if(e>=2){t.body.velocity.x=200}t.body.bounce.set(1)}doors=game.add.group();doors.enableBody=true;for(var e=0;e<doorPositions.length;e++){var n=doorPositions[e];var r=[];for(var i=0;i<n.length;i++){var s=doors.create(n[i].x,n[i].y,"door");s.body.immovable=true;r.push(s)}var o=new Key(game,keyPositions[e].x,keyPositions[e].y,r);game.physics.enable(o);keysArray.push(o)}trees=game.add.group();for(var e=0;e<treePositions.length;e++){var u=trees.create(treePositions[e].x,treePositions[e].y,"tree");game.physics.enable(u);u.body.immovable=true}game.camera.follow(player);cursors=game.input.keyboard.createCursorKeys();mainStyle={font:"30px Sans-serif",fill:"#000000"};timer=game.time.create(false);timer.start();btnUp=game.add.button(128,288,"buttonvertical",null,this,0,1,0,1);btnUp.fixedToCamera=true;btnUp.events.onInputOver.add(function(){up=true});btnUp.events.onInputOut.add(function(){up=false});btnUp.events.onInputDown.add(function(){up=true});btnUp.events.onInputUp.add(function(){up=false});btnLeft=game.add.button(32,352,"buttonhorizontal",null,this,0,1,0,1);btnLeft.fixedToCamera=true;btnLeft.events.onInputOver.add(function(){left=true});btnLeft.events.onInputOut.add(function(){left=false});btnLeft.events.onInputDown.add(function(){left=true});btnLeft.events.onInputUp.add(function(){left=false});btnDown=game.add.button(128,416,"buttonvertical",null,this,0,1,0,1);btnDown.fixedToCamera=true;btnDown.events.onInputOver.add(function(){down=true});btnDown.events.onInputOut.add(function(){down=false});btnDown.events.onInputDown.add(function(){down=true});btnDown.events.onInputUp.add(function(){down=false});btnRight=game.add.button(192,352,"buttonhorizontal",null,this,0,1,0,1);btnRight.fixedToCamera=true;btnRight.events.onInputOver.add(function(){right=true});btnRight.events.onInputOut.add(function(){right=false});btnRight.events.onInputDown.add(function(){right=true});btnRight.events.onInputUp.add(function(){right=false})},update:function(){game.physics.arcade.collide(player,layer);game.physics.arcade.collide(enemies,layer);game.physics.arcade.collide(hearts,layer);game.physics.arcade.overlap(player,enemies,this.gameOver,null,this);game.physics.arcade.collide(player,doors);game.physics.arcade.overlap(player,hearts,this.getHeart,null,this);game.physics.arcade.collide(player,princess,this.promtChest,null,this);game.physics.arcade.collide(player,chest,this.openChest,null,this);game.physics.arcade.collide(player,trees);for(var e=0;e<keysArray.length;e++){game.physics.arcade.overlap(player,keysArray[e],this.getKey,null,this)}player.body.velocity.x=0;player.body.velocity.y=0;if(resultText==null){this.processMoving()}if(score==3){this.beforeGoodGame()}},getHeart:function(e,t){score+=1;t.body.enable=false;var n=Phaser.Timer.SECOND*.5;game.add.tween(t.scale).to({x:2,y:2},n,Phaser.Easing.Linear.None,true,0,1e3,true);game.add.tween(t).to({alpha:0},n,Phaser.Easing.Linear.None,true,0,1e3,true);game.add.tween(t.position).to({x:t.position.x-t.width/2,y:t.position.y-t.height/2},n,Phaser.Easing.Linear.None,true,0,1e3,true);game.time.events.add(n,function(){t.kill()},this)},checkOverlap:function(e,t){var n=e.getBounds();var r=t.getBounds();return Phaser.Rectangle.intersects(n,r)},gameOver:function(e,t){e.kill();this.restart()},restart:function(){player.reset(respawnPosition.x,respawnPosition.y)},beforeGoodGame:function(){if(princess==null){enemies.destroy();princess=game.add.sprite(princessPosition.x,princessPosition.y,"princess");game.physics.enable(princess);princess.body.immovable=true}if(chest==null){chest=game.add.sprite(chestPosition.x,chestPosition.y,"chest");game.physics.enable(chest);chest.body.immovable=true}trees.destroy()},goodGame:function(){if(timerText==null){btnUp.destroy();btnRight.destroy();btnDown.destroy();btnLeft.destroy();if(emitter==null){emitter=game.add.emitter(chest.position.x,0,200);emitter.makeParticles(["star","diamond","flower"]);emitter.gravity=200;emitter.start(false,5e3,20)}player.animations.stop();player.frame=0;timer.pause();seconds=Math.floor(timer.seconds%60);minutes=Math.floor(timer.ms/Phaser.Timer.MINUTE);if(seconds<10){seconds="0"+seconds}if(minutes<10){minutes="0"+minutes}timerText=game.add.text(game.width/2,game.height/2-32,"",mainStyle);timerText.text=minutes+":"+seconds;timerText.fixedToCamera=true;timerText.anchor.set(.5);var e=Phaser.Timer.SECOND/2;game.add.tween(timerText.scale).to({x:1.5,y:1.5},e,Phaser.Easing.Linear.None,true,0,1e3,true);var t=83;resultText=game.add.text(game.width/2,game.height/2+32,"你超过了"+t+"%的玩家",mainStyle);resultText.anchor.set(.5);resultText.align="center";resultText.fixedToCamera=true}},fullScreen:function(){game.scale.startFullScreen(false)},getKey:function(e,t){t.kill();var n=Phaser.Timer.SECOND*.5;for(var r=0;r<t.doorSet.length;r++){var i=t.doorSet[r];game.add.tween(i.scale).to({x:0,y:0},n,Phaser.Easing.Linear.None,true,0,1e3,true);game.add.tween(i.position).to({x:i.position.x+i.width/2,y:i.position.y+i.height/2},n,Phaser.Easing.Linear.None,true,0,1e3,true)}game.time.events.add(n,function(){t.doorSet.forEach(function(e){e.kill()})},this)},openChest:function(e,t){if(invitText==null){if(promtText!=null){promtText.destroy()}var n={font:"30px Sans-serif",fill:"#ffffff"};invitText=game.add.text(game.width/2,32,"获得宝物!",n);invitText.anchor.set(.5);invitText.align="center";invitText.fixedToCamera=true;this.goodGame()}},updateTimer:function(){},processMoving:function(){if(cursors.left.isDown||left){face=WEST;player.body.velocity.x=-200;player.animations.play("walk_left")}else if(cursors.right.isDown||right){face=EAST;player.body.velocity.x=200;player.animations.play("walk_right")}else if(cursors.up.isDown||up){face=NORTH;player.body.velocity.y=-200;player.animations.play("walk_up")}else if(cursors.down.isDown||down){face=SOUTH;player.body.velocity.y=200;player.animations.play("walk_down")}else{player.animations.stop();switch(face){case NORTH:player.frame=3;break;case SOUTH:player.frame=0;break;case WEST:player.frame=6;break;case EAST:player.frame=9;break}}},promtChest:function(){if(promtText==null){var e={font:"30px Sans-serif",fill:"#ffffff"};promtText=game.add.text(game.width/2,32,"去东边的房间看看！",e);promtText.anchor.set(.5);promtText.align="center";promtText.fixedToCamera=true}}};game.state.add("main",mainState);game.state.start("main")