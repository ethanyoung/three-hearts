function createPoint(e,t){return new Phaser.Point(32*e,32*t)}Key=function(e,t,a,n){Phaser.Sprite.call(this,e,t,a,"key"),this.doorSet=n,e.add.existing(this)},Key.prototype=Object.create(Phaser.Sprite.prototype),Key.prototype.constructor=Key;var game=new Phaser.Game(320,480,Phaser.CANVAS,"game-screen"),NORTH=0,SOUTH=1,EAST=2,WEST=3,score,player,princess,cursors,map,hearts,enemies,emitter,up=!1,right=!1,down=!1,left=!1,face=SOUTH,doors,keysArray=[],chest,invitText,resultText,timer,timerText,mainStyle,promtText,trees,respawnPosition=createPoint(5,2),heartPositions=[createPoint(1.5,19.5),createPoint(7.5,19.5),createPoint(2,36)],enemyPositions=[createPoint(15,20),createPoint(17,20),createPoint(4,13),createPoint(15,23),createPoint(4,36)],keyPositions=[createPoint(2,15),createPoint(23,2),createPoint(1.5,29)],doorPositions=[[createPoint(7,17),createPoint(8,17)],[createPoint(15,20),createPoint(16,20),createPoint(17,20),createPoint(3,19),createPoint(3,20)],[createPoint(26,19),createPoint(27,19),createPoint(28,19)]],princessPosition=createPoint(40.5,8),chestPosition=createPoint(55,25),treePositions=[createPoint(26,22),createPoint(26,23)],mainState={preload:function(){game.load.tilemap("map","assets/tilemaps/maps/main.min.json",null,Phaser.Tilemap.TILED_JSON),game.load.image("tiles","assets/tilemaps/tiles/tiles.png"),game.load.image("heart","assets/sprites/heart.png"),game.load.image("enemy","assets/sprites/enemy.png"),game.load.image("flower","assets/sprites/flower.png"),game.load.image("diamond","assets/sprites/diamond.png"),game.load.image("star","assets/sprites/star_particle.png"),game.load.image("key","assets/sprites/key.png"),game.load.image("door","assets/sprites/door.png"),game.load.image("princess","assets/sprites/princess.png"),game.load.image("chest","assets/sprites/chest.png"),game.load.spritesheet("player","assets/sprites/player.png",28,32),game.load.spritesheet("buttonvertical","assets/buttons/button-vertical.png",64,64),game.load.spritesheet("buttonhorizontal","assets/buttons/button-horizontal.png",96,64),game.load.spritesheet("tree","assets/tilemaps/tiles/tiles.png",32,32,1),game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,game.scale.fullScreenScaleMode=Phaser.ScaleManager.EXACT_FIT},create:function(){game.device.desktop||game.input.onDown.add(this.fullScreen,this),score=0,game.physics.startSystem(Phaser.Physics.ARCADE),map=game.add.tilemap("map"),map.addTilesetImage("tiles"),layer=map.createLayer("Tile Layer 1"),layer.resizeWorld(),map.setCollisionBetween(1,8),player=game.add.sprite(respawnPosition.x,respawnPosition.y,"player"),game.physics.enable(player),player.body.fixedRotation=!0,player.body.collideWorldBounds=!0,player.animations.add("walk_down",[1,2],5,!0),player.animations.add("walk_up",[4,5],5,!0),player.animations.add("walk_left",[7,8],5,!0),player.animations.add("walk_right",[10,11],5,!0),hearts=game.add.group(),hearts.enableBody=!0;for(var e=0;e<heartPositions.length;e++)hearts.create(heartPositions[e].x,heartPositions[e].y,"heart");enemies=game.add.group(),enemies.enableBody=!0;for(var e=0;e<enemyPositions.length;e++){var t=enemies.create(enemyPositions[e].x,enemyPositions[e].y,"enemy");e>=2&&(t.body.velocity.x=200),t.body.bounce.set(1)}doors=game.add.group(),doors.enableBody=!0;for(var e=0;e<doorPositions.length;e++){for(var a=doorPositions[e],n=[],s=0;s<a.length;s++){var i=doors.create(a[s].x,a[s].y,"door");i.body.immovable=!0,n.push(i)}var o=new Key(game,keyPositions[e].x,keyPositions[e].y,n);game.physics.enable(o),keysArray.push(o)}trees=game.add.group();for(var e=0;e<treePositions.length;e++){var r=trees.create(treePositions[e].x,treePositions[e].y,"tree");game.physics.enable(r),r.body.immovable=!0}game.camera.follow(player),cursors=game.input.keyboard.createCursorKeys(),mainStyle={font:"30px Sans-serif",fill:"#000000"},timer=game.time.create(!1),timer.start(),btnUp=game.add.button(128,288,"buttonvertical",null,this,0,1,0,1),btnUp.fixedToCamera=!0,btnUp.events.onInputOver.add(function(){up=!0}),btnUp.events.onInputOut.add(function(){up=!1}),btnUp.events.onInputDown.add(function(){up=!0}),btnUp.events.onInputUp.add(function(){up=!1}),btnLeft=game.add.button(32,352,"buttonhorizontal",null,this,0,1,0,1),btnLeft.fixedToCamera=!0,btnLeft.events.onInputOver.add(function(){left=!0}),btnLeft.events.onInputOut.add(function(){left=!1}),btnLeft.events.onInputDown.add(function(){left=!0}),btnLeft.events.onInputUp.add(function(){left=!1}),btnDown=game.add.button(128,416,"buttonvertical",null,this,0,1,0,1),btnDown.fixedToCamera=!0,btnDown.events.onInputOver.add(function(){down=!0}),btnDown.events.onInputOut.add(function(){down=!1}),btnDown.events.onInputDown.add(function(){down=!0}),btnDown.events.onInputUp.add(function(){down=!1}),btnRight=game.add.button(192,352,"buttonhorizontal",null,this,0,1,0,1),btnRight.fixedToCamera=!0,btnRight.events.onInputOver.add(function(){right=!0}),btnRight.events.onInputOut.add(function(){right=!1}),btnRight.events.onInputDown.add(function(){right=!0}),btnRight.events.onInputUp.add(function(){right=!1})},update:function(){game.physics.arcade.collide(player,layer),game.physics.arcade.collide(enemies,layer),game.physics.arcade.collide(hearts,layer),game.physics.arcade.overlap(player,enemies,this.gameOver,null,this),game.physics.arcade.collide(player,doors),game.physics.arcade.overlap(player,hearts,this.getHeart,null,this),game.physics.arcade.collide(player,princess,this.promtChest,null,this),game.physics.arcade.collide(player,chest,this.openChest,null,this),game.physics.arcade.collide(player,trees);for(var e=0;e<keysArray.length;e++)game.physics.arcade.overlap(player,keysArray[e],this.getKey,null,this);player.body.velocity.x=0,player.body.velocity.y=0,null==resultText&&this.processMoving(),3==score&&this.beforeGoodGame()},getHeart:function(e,t){score+=1,t.body.enable=!1;var a=.5*Phaser.Timer.SECOND;game.add.tween(t.scale).to({x:2,y:2},a,Phaser.Easing.Linear.None,!0,0,1e3,!0),game.add.tween(t).to({alpha:0},a,Phaser.Easing.Linear.None,!0,0,1e3,!0),game.add.tween(t.position).to({x:t.position.x-t.width/2,y:t.position.y-t.height/2},a,Phaser.Easing.Linear.None,!0,0,1e3,!0),game.time.events.add(a,function(){t.kill()},this)},checkOverlap:function(e,t){var a=e.getBounds(),n=t.getBounds();return Phaser.Rectangle.intersects(a,n)},gameOver:function(e,t){e.kill(),this.restart()},restart:function(){player.reset(respawnPosition.x,respawnPosition.y)},beforeGoodGame:function(){null==princess&&(enemies.destroy(),princess=game.add.sprite(princessPosition.x,princessPosition.y,"princess"),game.physics.enable(princess),princess.body.immovable=!0),null==chest&&(chest=game.add.sprite(chestPosition.x,chestPosition.y,"chest"),game.physics.enable(chest),chest.body.immovable=!0),trees.destroy()},goodGame:function(){if(null==timerText){btnUp.destroy(),btnRight.destroy(),btnDown.destroy(),btnLeft.destroy(),null==emitter&&(emitter=game.add.emitter(player.position.x,player.position.y-288,200),emitter.makeParticles(["star","diamond","flower"]),emitter.gravity=200,emitter.start(!1,5e3,20)),player.animations.stop(),player.frame=0,timer.pause(),seconds=Math.floor(timer.seconds%60),minutes=Math.floor(timer.ms/Phaser.Timer.MINUTE),seconds<10&&(seconds="0"+seconds),minutes<10&&(minutes="0"+minutes),timerText=game.add.text(game.width/2,game.height/2-32,"",mainStyle),timerText.text=minutes+":"+seconds,timerText.fixedToCamera=!0,timerText.anchor.set(.5);var e=Phaser.Timer.SECOND/2;game.add.tween(timerText.scale).to({x:1.5,y:1.5},e,Phaser.Easing.Linear.None,!0,0,1e3,!0);var t=83;resultText=game.add.text(game.width/2,game.height/2+32,"You've overtaken\n"+t+"%\nof the players",mainStyle),resultText.anchor.set(.5),resultText.align="center",resultText.fixedToCamera=!0}},fullScreen:function(){game.scale.startFullScreen(!1)},getKey:function(e,t){t.kill();for(var a=.5*Phaser.Timer.SECOND,n=0;n<t.doorSet.length;n++){var s=t.doorSet[n];game.add.tween(s.scale).to({x:0,y:0},a,Phaser.Easing.Linear.None,!0,0,1e3,!0),game.add.tween(s.position).to({x:s.position.x+s.width/2,y:s.position.y+s.height/2},a,Phaser.Easing.Linear.None,!0,0,1e3,!0)}game.time.events.add(a,function(){t.doorSet.forEach(function(e){e.kill()})},this)},openChest:function(e,t){if(null==invitText){null!=promtText&&promtText.destroy();var a={font:"30px Sans-serif",fill:"#ffffff"};invitText=game.add.text(game.width/2,32,"Got treasure!",a),invitText.anchor.set(.5),invitText.align="center",invitText.fixedToCamera=!0,this.goodGame()}},updateTimer:function(){},processMoving:function(){if(cursors.left.isDown||left)face=WEST,player.body.velocity.x=-200,player.animations.play("walk_left");else if(cursors.right.isDown||right)face=EAST,player.body.velocity.x=200,player.animations.play("walk_right");else if(cursors.up.isDown||up)face=NORTH,player.body.velocity.y=-200,player.animations.play("walk_up");else if(cursors.down.isDown||down)face=SOUTH,player.body.velocity.y=200,player.animations.play("walk_down");else switch(player.animations.stop(),face){case NORTH:player.frame=3;break;case SOUTH:player.frame=0;break;case WEST:player.frame=6;break;case EAST:player.frame=9}},promtChest:function(){if(null==promtText){var e={font:"30px Sans-serif",fill:"#ffffff"};promtText=game.add.text(game.width/2,32,"Go to east！",e),promtText.anchor.set(.5),promtText.align="center",promtText.fixedToCamera=!0}}};game.state.add("main",mainState),game.state.start("main");